#include <stdio.h>
#include <stdlib.h>
#include <time.h>
#include "rlutil.h"

#define ROW 4
#define COL 4

char board[ROW][COL];
int revealed[ROW][COL] = {0};

void initBoard() {
    char cards[ROW * COL];
    int i, j, k = 0;

    for (i = 0; i < (ROW * COL) / 2; i++) {
        cards[k++] = 'A' + i;
        cards[k++] = 'A' + i;
    }

    srand(time(NULL));
    for (i = ROW * COL - 1; i > 0; i--) {
        int r = rand() % (i + 1);
        char temp = cards[i];
        cards[i] = cards[r];
        cards[r] = temp;
    }

    k = 0;
    for (i = 0; i < ROW; i++)
        for (j = 0; j < COL; j++)
            board[i][j] = cards[k++];
}

void drawBoard(int cx, int cy) {
    int i, j;
    cls();
    printf("=== Memory Card Game ===\n\n");

    for (i = 0; i < ROW; i++) {
        for (j = 0; j < COL; j++) {
            if (i == cx && j == cy)
                setBackgroundColor(GREY);
            else
                setBackgroundColor(BLACK);

            if (revealed[i][j])
                printf(" %c ", board[i][j]);
            else
                printf(" * ");
        }
        printf("\n");
    }
    setBackgroundColor(BLACK);
}

int isFinished() {
    int i, j;
    for (i = 0; i < ROW; i++)
        for (j = 0; j < COL; j++)
            if (!revealed[i][j])
                return 0;
    return 1;
}

int main() {
    int x = 0, y = 0;
    int fx = -1, fy = -1;

    hidecursor();
    initBoard();

    while (1) {
        drawBoard(x, y);

        if (isFinished()) {
            printf("\n遊戲完成！按任意鍵結束。\n");
            getkey();
            break;
        }

        int key = getkey();

        if (key == KEY_UP && x > 0) x--;
        if (key == KEY_DOWN && x < ROW - 1) x++;
        if (key == KEY_LEFT && y > 0) y--;
        if (key == KEY_RIGHT && y < COL - 1) y++;

        if (key == KEY_ENTER && !revealed[x][y]) {
            revealed[x][y] = 1;
            drawBoard(x, y);

            if (fx == -1) {
                fx = x;
                fy = y;
            } else {
                if (board[fx][fy] != board[x][y]) {
                    msleep(800);
                    revealed[fx][fy] = 0;
                    revealed[x][y] = 0;
                }
                fx = fy = -1;
            }
        }
    }

    showcursor();
    return 0;
}
